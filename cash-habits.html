<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cash Habits</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Cash Habits" />

<style>
  :root{
    --bg:#0f1115; --card:#171a21; --ink:#e9ecf1; --muted:#9aa3b2; --ring:#2a2f3a; --shadow:#0006;
    --good:#1b8f63; --good-d:#117d57; --bad:#b0232c; --bad-d:#7f1820; --neutral:#2a3142;
    --green:#20c997; --red:#ff6b6b; --grey:#3b4356;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
    -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%;
  }
  .app{ max-width:860px; margin:0 auto; padding: env(safe-area-inset-top) 14px 18px }
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .split{justify-content:space-between}
  .center{justify-content:center}
  .grow{flex:1}
  .sub{color:var(--muted); font-size:12px}
  .balance{font-weight:800; font-size:26px}
  .big{font-weight:800; font-size:22px}
  .topbar{
    position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(15,17,21,.92), rgba(15,17,21,.76) 60%, transparent);
    padding: 10px 0 12px; border-bottom:1px solid #141824;
  }

  .card{
    background:linear-gradient(180deg, var(--card), #141821);
    border:1.5px solid var(--ring); border-radius:16px; padding:14px;
    box-shadow: 0 10px 20px var(--shadow); margin:12px 0;
  }
  .card h3{margin:0 0 6px; font-size:18px}
  .input, .number, select{
    width:100%; box-sizing:border-box; padding:12px 12px; color:var(--ink);
    background:#0e121b; border:1px solid var(--ring); border-radius:12px; outline:none;
  }
  .number{appearance:textfield}
  .number::-webkit-outer-spin-button,.number::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

  .btn{
    appearance:none; -webkit-appearance:none; cursor:pointer;
    border:1px solid var(--ring); background:transparent; color:var(--ink);
    padding:10px 14px; border-radius:12px; font-weight:700; transition:.15s transform ease;
  }
  .btn:active{ transform: translateY(1px) }
  .btn.small{ padding:6px 8px; border-radius:10px; font-size:12px }

  /* Tally buttons */
  .tallyBtn{
    appearance:none; -webkit-appearance:none; cursor:pointer; user-select:none;
    border:2px solid transparent; color:#fff; font-size:22px; font-weight:800;
    display:inline-grid; place-items:center; min-width:64px; min-height:56px; border-radius:14px;
    box-shadow: 0 6px 18px var(--shadow);
  }
  .tallyUp{ background:linear-gradient(180deg, var(--good), var(--good-d)) }
  .tallyDown{ background:linear-gradient(180deg, var(--bad), var(--bad-d)) }

  .tag{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
    background:#0f1320; border:1px solid #1a2030; color:#cfd6e6; font-size:12px; font-weight:700;
  }

  /* Mini streak chart dots (per habit) */
  .streak{ display:flex; gap:4px; flex-wrap:wrap; margin-top:6px }
  .dot{ width:12px; height:12px; border-radius:4px; border:1px solid #2a3142; background:#0f1320 }
  .dot.plus{ background:#1b8f63 }
  .dot.minus{ background:#7f1820 }
  .dot.today{ outline:2px solid #e9ecf1; outline-offset:1px }

  /* Daily points bar graph */
  .graphWrap{ width:100%; height:140px; }
  #dailyGraph{ width:100%; height:140px; display:block; }

  /* Confetti canvas */
  #fx{ position:fixed; inset:0; width:100vw; height:100vh; pointer-events:none; z-index:999 }
  .spacer{height: env(safe-area-inset-bottom)}
  .emoji{font-size:18px}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="app">
  <!-- Header / Tally -->
  <div class="topbar">
    <div class="row split">
      <div>
        <div class="sub">Cash Available</div>
        <div class="balance" id="cashTotal">$0.00</div>
      </div>
      <div>
        <div class="sub">Points</div>
        <div class="balance" id="pointsTotal">0</div>
      </div>
      <div class="row">
        <button class="btn" id="spendBtn">üõçÔ∏è Spend</button>
        <button class="btn" id="settingsBtn">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="row center" style="gap:14px; margin-top:10px">
      <button class="tallyBtn tallyUp" id="tallyUp">‚¨ÜÔ∏è</button>
      <div class="tag">Today: <span id="todayText">‚Äî</span> ¬∑ Step ¬±<span id="stepDisplay">$5</span></div>
      <button class="tallyBtn tallyDown" id="tallyDown">‚¨áÔ∏è</button>
    </div>
  </div>

  <!-- Graph -->
  <div class="card">
    <h3>Daily Points</h3>
    <div class="graphWrap"><canvas id="dailyGraph" width="800" height="140"></canvas></div>
    <div class="sub">Green = net positive ‚Ä¢ Red = net negative</div>
  </div>

  <!-- Habits -->
  <div class="card">
    <h3>Habits (good)</h3>
    <div id="habitList"></div>
    <div class="row" style="gap:8px; margin-top:10px">
      <input id="newHabitName" class="input" placeholder="Habit name (e.g., Mindfulness)" />
      <input id="newHabitEmoji" class="input" placeholder="Emoji (e.g., üßò)" style="max-width:110px" />
      <input id="newHabitColor" type="color" class="input" value="#7ee787" style="max-width:110px; padding:6px 8px; height:44px" />
    </div>
    <div class="row" style="gap:8px; margin-top:6px">
      <input id="newHabitStart" type="number" class="number" min="0" step="1" placeholder="Start reward $ (default 20)" />
      <input id="newHabitPts" type="number" class="number" step="1" placeholder="Points per completion (default 10)" />
      <button class="btn" id="addHabitBtn">Add Habit</button>
    </div>
  </div>

  <!-- Vices -->
  <div class="card">
    <h3>Vices (temptations)</h3>
    <div id="viceList"></div>
    <div class="row" style="gap:8px; margin-top:10px">
      <input id="newViceName" class="input" placeholder="Vice name (e.g., Doomscroll)" />
      <input id="newViceEmoji" class="input" placeholder="Emoji (e.g., üì±)" style="max-width:110px" />
      <input id="newViceColor" type="color" class="input" value="#ff6b6b" style="max-width:110px; padding:6px 8px; height:44px" />
    </div>
    <div class="row" style="gap:8px; margin-top:6px">
      <input id="newViceCash" type="number" class="number" step="1" placeholder="Cash penalty $ (default 0)" />
      <input id="newVicePts" type="number" class="number" step="1" placeholder="Points penalty (default 10)" />
      <button class="btn" id="addViceBtn">Add Vice</button>
    </div>
  </div>

  <!-- History (today) -->
  <div class="card">
    <h3>Today</h3>
    <div id="todayHistory"></div>
  </div>

  <div class="spacer"></div>
</div>

<!-- Spend Modal -->
<dialog id="spendModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3>Spend Cash</h3>
    <div class="row"><input id="spendAmt" class="number" type="number" min="0" step="1" placeholder="Amount $" /></div>
    <div class="row"><input id="spendNote" class="input" placeholder="What did you buy? (optional)" /></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn" value="submit">Spend</button>
    </div>
  </form>
</dialog>

<!-- Tally Up Modal (choose habit) -->
<dialog id="upModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3>What did you do?</h3>
    <div id="upList"></div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" value="cancel">Close</button>
    </div>
  </form>
</dialog>

<!-- Tally Down Modal (choose habit missed or vice did) -->
<dialog id="downModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3>Log a miss or a vice</h3>
    <div class="row" style="gap:8px">
      <select id="downMode">
        <option value="habit">Missed a habit</option>
        <option value="vice">Did a vice</option>
      </select>
    </div>
    <div id="downList" style="margin-top:10px"></div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" value="cancel">Close</button>
    </div>
  </form>
</dialog>

<!-- Edit Habit/Vice Modal -->
<dialog id="editModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3 id="editTitle">Edit</h3>
    <div class="row" style="gap:8px">
      <input id="editName" class="input" placeholder="Name" />
      <input id="editEmoji" class="input" placeholder="Emoji" style="max-width:110px" />
      <input id="editColor" type="color" class="input" value="#7ee787" style="max-width:110px; padding:6px 8px; height:44px" />
    </div>
    <div class="row" id="editMore" style="gap:8px; margin-top:8px"></div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn" value="submit">Save</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const fmt = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' });
  function todayKey(d=new Date()){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function niceDate(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }
  function cid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function round2(n){ return Math.round((Number(n)||0)*100)/100; }
  function buzz(ms=30){ try{ navigator.vibrate?.(ms); }catch{} }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Confetti & sound (lightweight)
  let audioCtx=null;
  function playBlip(){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.20);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.22);
    }catch{}
  }
  const fx = $('#fx'), fxCtx = fx.getContext('2d');
  function resizeFx(){ fx.width=innerWidth*devicePixelRatio; fx.height=innerHeight*devicePixelRatio; }
  addEventListener('resize', resizeFx); resizeFx();
  function confetti(hue=120){
    const N=80, parts=[];
    for(let i=0;i<N;i++){
      parts.push({x:Math.random()*fx.width,y:fx.height*0.3+(Math.random()*fx.height*0.1),vx:(Math.random()-0.5)*3,vy:-8-Math.random()*6,g:0.25,r:2+Math.random()*3,a:1,h:hue+Math.random()*40-20});
    }
    const start=performance.now();
    function tick(t){
      fxCtx.clearRect(0,0,fx.width,fx.height);
      for(const p of parts){ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a*=0.985;
        fxCtx.beginPath(); fxCtx.fillStyle=`hsla(${p.h},90%,70%,${p.a})`; fxCtx.arc(p.x,p.y,p.r,0,Math.PI*2); fxCtx.fill();
      }
      if(t-start<900) requestAnimationFrame(tick);
      else fxCtx.clearRect(0,0,fx.width,fx.height);
    }
    requestAnimationFrame(tick);
  }
  function hexToHue(hex){
    try{
      const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16)/255, g=parseInt(c.slice(2,4),16)/255, b=parseInt(c.slice(4,6),16)/255;
      const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn; let h=0;
      if(d===0) h=0; else if(mx===r) h=((g-b)/d)%6; else if(mx===g) h=(b-r)/d+2; else h=(r-g)/d+4;
      h=Math.round(60*h); if(h<0) h+=360; return h;
    }catch{ return 120; }
  }

  // ---------- State ----------
  const STORAGE_KEY='cashHabits.v5';
  /**
   * {
   *  version, step, cashTotal, pointsTotal,
   *  habits: [{id,name,emoji,color,incentive,step,points}], // points per completion
   *  vices: [{id,name,emoji,color,cashPenalty,pointsPenalty}],
   *  events: [{ts,date,type:'habitDone'|'habitMiss'|'vice'|'spend', habitId?, viceId?, cashDelta:number, pointsDelta:number, note?}]
   * }
   */
  let state = load();
  function load(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){ try{ return JSON.parse(saved); }catch{} }
    return {
      version:5,
      step:5,
      cashTotal:0,
      pointsTotal:0,
      habits:[
        { id:cid(), name:'Mindfulness', emoji:'üßò', color:'#7ee787', incentive:20, step:5, points:10 },
        { id:cid(), name:'Workout', emoji:'üí™', color:'#8b9cf6', incentive:20, step:5, points:12 },
      ],
      vices:[
        { id:cid(), name:'Doomscroll', emoji:'üì±', color:'#ff6b6b', cashPenalty:0, pointsPenalty:10 },
      ],
      events:[]
    };
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // ---------- Money / Points ----------
  function addEvent(ev){
    state.events.push(ev);
    state.cashTotal = round2(state.cashTotal + (ev.cashDelta||0));
    state.pointsTotal = Math.round((state.pointsTotal + (ev.pointsDelta||0)));
    save(); render();
  }

  // ---------- Tally Actions ----------
  function doHabitDone(h){
    const payout = Math.max(0, h.incentive);
    // Cash goes up by incentive, then incentive drops by step
    addEvent({ ts:Date.now(), date:todayKey(), type:'habitDone', habitId:h.id, cashDelta:payout, pointsDelta:(h.points||10) });
    h.incentive = Math.max(0, round2(h.incentive - (h.step||state.step)));
    buzz(30); playBlip(); confetti(hexToHue(h.color||'#7ee787'));
    save(); render();
  }
  function doHabitMiss(h){
    // Incentive increases by step, points go down by habit.points
    const step = Math.max(1, h.step||state.step);
    h.incentive = round2(h.incentive + step);
    addEvent({ ts:Date.now(), date:todayKey(), type:'habitMiss', habitId:h.id, cashDelta:0, pointsDelta:-(h.points||10) });
    buzz(15);
  }
  function doVice(v){
    // Cash penalty (subtract) and points penalty (subtract)
    const cashPen = -Math.abs(Number(v.cashPenalty||0));
    const ptsPen  = -Math.abs(Number(v.pointsPenalty||10));
    addEvent({ ts:Date.now(), date:todayKey(), type:'vice', viceId:v.id, cashDelta:cashPen, pointsDelta:ptsPen });
    buzz(15);
  }
  function spend(amount, note){
    const a=Number(amount)||0; if(a<=0) return;
    if(a>state.cashTotal){ alert(`You only have ${fmt.format(state.cashTotal)} available.`); return; }
    addEvent({ ts:Date.now(), date:todayKey(), type:'spend', cashDelta:-a, pointsDelta:0, note:String(note||'') });
  }

  // ---------- UI: Lists ----------
  function habitRow(h){
    const wrap=document.createElement('div');
    wrap.className='card';
    wrap.style.borderColor=h.color||'#7ee787';
    wrap.innerHTML=`
      <div class="row split">
        <div class="row" style="gap:10px">
          <div class="big"><span class="emoji">${escapeHTML(h.emoji||'')}</span> ${escapeHTML(h.name)}</div>
        </div>
        <div class="row" style="gap:8px">
          <span class="tag">${fmt.format(h.incentive)} next</span>
          <span class="tag">¬±$${h.step||state.step}</span>
          <span class="tag">+${h.points||10} pts</span>
          <button class="btn small" data-edit>üé® Edit</button>
          <button class="btn small" data-del>üóëÔ∏è</button>
        </div>
      </div>
      <div class="row center" style="gap:12px; margin-top:8px">
        <button class="tallyBtn tallyUp" data-done>‚úÖ</button>
        <button class="tallyBtn tallyDown" data-miss>‚úñÔ∏è</button>
      </div>
      <div class="streak" aria-label="mini chart">
        ${miniDots(h.id).join('')}
      </div>
    `;
    wrap.querySelector('[data-done]').onclick=()=>doHabitDone(h);
    wrap.querySelector('[data-miss]').onclick=()=>doHabitMiss(h);
    wrap.querySelector('[data-del]').onclick=()=>{ if(confirm('Delete habit?')){ state.habits=state.habits.filter(x=>x.id!==h.id); save(); render(); } };
    wrap.querySelector('[data-edit]').onclick=()=>openEdit('habit', h);
    return wrap;
  }
  function viceRow(v){
    const wrap=document.createElement('div');
    wrap.className='card';
    wrap.style.borderColor=v.color||'#ff6b6b';
    wrap.innerHTML=`
      <div class="row split">
        <div class="big"><span class="emoji">${escapeHTML(v.emoji||'')}</span> ${escapeHTML(v.name)}</div>
        <div class="row" style="gap:8px">
          <span class="tag">${v.cashPenalty?`‚àí${fmt.format(v.cashPenalty)}`:'$0'} cash</span>
          <span class="tag">‚àí${Math.abs(v.pointsPenalty||10)} pts</span>
          <button class="btn small" data-edit>üé® Edit</button>
          <button class="btn small" data-del>üóëÔ∏è</button>
        </div>
      </div>
      <div class="row center" style="gap:12px; margin-top:8px">
        <button class="tallyBtn tallyDown" data-do>Log ‚¨áÔ∏è</button>
      </div>
    `;
    wrap.querySelector('[data-do]').onclick=()=>doVice(v);
    wrap.querySelector('[data-del]').onclick=()=>{ if(confirm('Delete vice?')){ state.vices=state.vices.filter(x=>x.id!==v.id); save(); render(); } };
    wrap.querySelector('[data-edit]').onclick=()=>openEdit('vice', v);
    return wrap;
  }

  // ---------- Tally Modals ----------
  const upModal = $('#upModal');
  const upList  = $('#upList');
  const downModal = $('#downModal');
  const downList  = $('#downList');
  const downMode  = $('#downMode');

  $('#tallyUp').onclick = ()=>{
    upList.innerHTML = state.habits.length? '' : '<div class="sub">Add a habit first.</div>';
    state.habits.forEach(h=>{
      const b=document.createElement('button');
      b.className='btn'; b.style=`border-color:${h.color};`;
      b.textContent = `${h.emoji||''} ${h.name}  ¬∑ +${fmt.format(h.incentive)}  ¬∑ +${h.points||10}pts`;
      b.onclick = ()=>{ upModal.close(); doHabitDone(h); };
      upList.appendChild(b);
    });
    upModal.showModal();
  };

  function renderDownList(){
    downList.innerHTML='';
    if(downMode.value==='habit'){
      if(!state.habits.length){ downList.innerHTML='<div class="sub">Add a habit first.</div>'; return; }
      state.habits.forEach(h=>{
        const b=document.createElement('button');
        b.className='btn'; b.style=`border-color:${h.color};`;
        b.textContent = `${h.emoji||''} Missed ${h.name}  ¬∑ incentive +$${h.step||state.step}  ¬∑ ‚àí${h.points||10}pts`;
        b.onclick = ()=>{ downModal.close(); doHabitMiss(h); };
        downList.appendChild(b);
      });
    } else {
      if(!state.vices.length){ downList.innerHTML='<div class="sub">Add a vice first.</div>'; return; }
      state.vices.forEach(v=>{
        const b=document.createElement('button');
        b.className='btn'; b.style=`border-color:${v.color};`;
        const cashTxt = v.cashPenalty? ` ‚àí${fmt.format(Math.abs(v.cashPenalty))}` : '';
        b.textContent = `${v.emoji||''} ${v.name}  ¬∑${cashTxt}  ¬∑ ‚àí${Math.abs(v.pointsPenalty||10)}pts`;
        b.onclick = ()=>{ downModal.close(); doVice(v); };
        downList.appendChild(b);
      });
    }
  }
  downMode.onchange = renderDownList;
  $('#tallyDown').onclick = ()=>{ renderDownList(); downModal.showModal(); };

  // ---------- Edit Modal ----------
  let editObj=null, editType='habit';
  const editModal = $('#editModal');
  function openEdit(type, obj){
    editType=type; editObj=obj;
    $('#editTitle').textContent = type==='habit' ? 'Edit Habit' : 'Edit Vice';
    $('#editName').value = obj.name||'';
    $('#editEmoji').value = obj.emoji||'';
    $('#editColor').value = obj.color|| (type==='habit'?'#7ee787':'#ff6b6b');
    const more = $('#editMore'); more.innerHTML='';
    if(type==='habit'){
      more.innerHTML = `
        <input id="editIncentive" class="number" type="number" min="0" step="1" placeholder="Current reward $" value="${obj.incentive||0}" />
        <input id="editStep" class="number" type="number" min="1" step="1" placeholder="Step ¬±$" value="${obj.step||state.step}" />
        <input id="editPts" class="number" type="number" step="1" placeholder="Points per completion" value="${obj.points||10}" />
      `;
    } else {
      more.innerHTML = `
        <input id="editPenaltyCash" class="number" type="number" step="1" placeholder="Cash penalty $" value="${obj.cashPenalty||0}" />
        <input id="editPenaltyPts" class="number" type="number" step="1" placeholder="Points penalty" value="${obj.pointsPenalty||10}" />
      `;
    }
    editModal.showModal();
  }
  editModal.addEventListener('close', ()=>{
    if(editModal.returnValue==='submit' && editObj){
      editObj.name = String($('#editName').value||editObj.name);
      editObj.emoji = String($('#editEmoji').value||'').slice(0,2);
      editObj.color = $('#editColor').value || editObj.color;
      if(editType==='habit'){
        const n1=Number($('#editIncentive').value); if(isFinite(n1)&&n1>=0) editObj.incentive=round2(n1);
        const n2=Number($('#editStep').value); if(isFinite(n2)&&n2>=1) editObj.step=Math.round(n2);
        const n3=Number($('#editPts').value); if(isFinite(n3)) editObj.points=Math.round(n3);
      }else{
        const p1=Number($('#editPenaltyCash').value); if(isFinite(p1)) editObj.cashPenalty=Math.round(p1);
        const p2=Number($('#editPenaltyPts').value); if(isFinite(p2)) editObj.pointsPenalty=Math.round(p2);
      }
      save(); render();
    }
    editObj=null;
  });

  // ---------- Add Habit / Vice ----------
  $('#addHabitBtn').onclick = ()=>{
    const name=$('#newHabitName').value.trim(); if(!name){ alert('Enter a habit name'); return; }
    const emoji=$('#newHabitEmoji').value.trim().slice(0,2);
    const color=$('#newHabitColor').value || '#7ee787';
    let start=Number($('#newHabitStart').value); if(!isFinite(start)||start<0) start=20;
    let pts=Number($('#newHabitPts').value); if(!isFinite(pts)) pts=10;
    state.habits.push({ id:cid(), name, emoji, color, incentive:round2(start), step:state.step, points:Math.round(pts) });
    $('#newHabitName').value=''; $('#newHabitEmoji').value=''; $('#newHabitStart').value=''; $('#newHabitPts').value='';
    save(); render();
  };
  $('#addViceBtn').onclick = ()=>{
    const name=$('#newViceName').value.trim(); if(!name){ alert('Enter a vice name'); return; }
    const emoji=$('#newViceEmoji').value.trim().slice(0,2);
    const color=$('#newViceColor').value || '#ff6b6b';
    let cash=Number($('#newViceCash').value); if(!isFinite(cash)) cash=0;
    let pts=Number($('#newVicePts').value); if(!isFinite(pts)) pts=10;
    state.vices.push({ id:cid(), name, emoji, color, cashPenalty:Math.round(cash), pointsPenalty:Math.round(pts) });
    $('#newViceName').value=''; $('#newViceEmoji').value=''; $('#newViceCash').value=''; $('#newVicePts').value='';
    save(); render();
  };

  // ---------- Spend / Settings ----------
  const spendModal = $('#spendModal');
  $('#spendBtn').onclick = ()=>spendModal.showModal();
  spendModal.addEventListener('close', ()=>{
    if(spendModal.returnValue==='submit'){
      spend($('#spendAmt').value, $('#spendNote').value);
      $('#spendAmt').value=''; $('#spendNote').value='';
    }
  });

  const settingsModal = document.createElement('dialog');
  settingsModal.innerHTML = `
    <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
      <h3>Settings</h3>
      <div class="row" style="gap:10px">
        <label class="tag">Default Step (¬±)</label>
        <input id="stepInput" class="number" type="number" min="1" step="1" />
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" value="cancel">Close</button>
        <button class="btn" value="submit">Save</button>
      </div>
    </form>`;
  document.body.appendChild(settingsModal);
  $('#settingsBtn').onclick = ()=>{
    settingsModal.querySelector('#stepInput').value = state.step;
    settingsModal.showModal();
  };
  settingsModal.addEventListener('close', ()=>{
    if(settingsModal.returnValue==='submit'){
      const n=Math.max(1, Math.floor(Number(settingsModal.querySelector('#stepInput').value)||state.step||5));
      state.step=n; save(); render();
    }
  });

  // ---------- History / Graph ----------
  function renderHistory(){
    const k=todayKey();
    const box = $('#todayHistory');
    const todays = state.events.filter(e=>e.date===k).slice(-20);
    box.innerHTML = todays.length? todays.map(e=>{
      if(e.type==='habitDone'){
        const h = state.habits.find(x=>x.id===e.habitId);
        return `<div class="row split" style="margin:6px 0"><div>‚úÖ ${escapeHTML(h?.name||'Habit')}</div><div>+${fmt.format(e.cashDelta)} ¬∑ +${e.pointsDelta}pts</div></div>`;
      } else if(e.type==='habitMiss'){
        const h = state.habits.find(x=>x.id===e.habitId);
        return `<div class="row split" style="margin:6px 0"><div>‚úñÔ∏è Missed ${escapeHTML(h?.name||'Habit')}</div><div>+${fmt.format(0)} ¬∑ ‚àí${Math.abs(e.pointsDelta)}pts</div></div>`;
      } else if(e.type==='vice'){
        const v = state.vices.find(x=>x.id===e.viceId);
        const cash = e.cashDelta? `${e.cashDelta<0?'‚àí':''}${fmt.format(Math.abs(e.cashDelta))}` : '$0.00';
        return `<div class="row split" style="margin:6px 0"><div>‚¨áÔ∏è ${escapeHTML(v?.name||'Vice')}</div><div>${cash} ¬∑ ‚àí${Math.abs(e.pointsDelta)}pts</div></div>`;
      } else {
        return `<div class="row split" style="margin:6px 0"><div>üõçÔ∏è ${escapeHTML(e.note||'Spent')}</div><div>‚àí${fmt.format(Math.abs(e.cashDelta||0))}</div></div>`;
      }
    }).join('') : `<div class="sub">No entries yet today.</div>`;
  }

  function dayPoints(dateKey){
    return state.events.filter(e=>e.date===dateKey).reduce((s,e)=>s+(e.pointsDelta||0),0);
  }
  function drawDailyGraph(){
    const c = $('#dailyGraph'), ctx=c.getContext('2d');
    const W=c.width, H=c.height;
    ctx.clearRect(0,0,W,H);
    const days=[];
    for(let i=13;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i); const k=todayKey(d);
      days.push({k, val: dayPoints(k)});
    }
    const maxAbs = Math.max(10, ...days.map(d=>Math.abs(d.val)));
    const barW = W / days.length - 6;
    ctx.textAlign='center'; ctx.textBaseline='alphabetic'; ctx.fillStyle='#aab';
    days.forEach((d, idx)=>{
      const x = idx*(W/days.length)+3;
      const mid=H*0.62;
      const h = (Math.abs(d.val)/maxAbs)*(H*0.52);
      const y = d.val>=0 ? mid - h : mid;
      ctx.fillStyle = d.val>=0 ? getComputedStyle(document.documentElement).getPropertyValue('--green') || '#20c997'
                               : getComputedStyle(document.documentElement).getPropertyValue('--red')   || '#ff6b6b';
      ctx.fillRect(x, y, barW, Math.max(2, h));
      // today marker
      if(idx===days.length-1){
        ctx.fillStyle='#e9ecf1'; ctx.fillRect(x, mid-1, barW, 2);
      } else {
        ctx.fillStyle='#4a4f65'; ctx.fillRect(x, mid, barW, 1);
      }
    });
  }

  // Mini 14-day dots per habit
  function miniDots(habitId){
    const dots=[];
    for(let i=13;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i); const k=todayKey(d);
      const ev = state.events.filter(e=>e.date===k && (e.habitId===habitId) );
      const plus = ev.some(e=>e.type==='habitDone');
      const minusOnly = !plus && ev.some(e=>e.type==='habitMiss');
      dots.push(`<span class="dot ${plus?'plus':(minusOnly?'minus':'')} ${i===0?'today':''}" title="${k}"></span>`);
    }
    return dots;
  }

  // ---------- Render ----------
  function render(){
    $('#cashTotal').textContent = fmt.format(state.cashTotal);
    $('#pointsTotal').textContent = String(state.pointsTotal);
    $('#todayText').textContent = niceDate(new Date());
    $('#stepDisplay').textContent = `$${state.step}`;

    // Habits
    const hList = $('#habitList'); hList.innerHTML='';
    state.habits.forEach(h=> hList.appendChild(habitRow(h)));

    // Vices
    const vList = $('#viceList'); vList.innerHTML='';
    state.vices.forEach(v=> vList.appendChild(viceRow(v)));

    // History + graph
    renderHistory();
    drawDailyGraph();
  }

  // ---------- Spend ----------
  $('#spendModal').addEventListener('close', ()=>{
    // handled earlier
  });

  // ---------- Init ----------
  render();
})();
</script>
</body>
</html
