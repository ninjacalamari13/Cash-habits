<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cash Habit Rewards</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Cash Habits" />

<style>
  :root{
    --bg:#0f1115; --card:#171a21; --ink:#e9ecf1; --muted:#9aa3b2;
    --ring:#2a2f3a; --shadow:#00000055;
    --good:#1b8f63; --good-d:#117d57;
    --bad:#b0232c; --bad-d:#7f1820;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
    -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%;
  }
  .app{ max-width:820px; margin:0 auto; padding: env(safe-area-inset-top) 14px 18px }
  .topbar{
    position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(15,17,21,.92), rgba(15,17,21,.76) 60%, transparent);
    padding: 10px 0 12px; border-bottom:1px solid #141824;
  }
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .row.split{justify-content:space-between}
  .center{justify-content:center}
  .grow{flex:1}
  .balance{font-weight:800; font-size:26px; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px}
  .section-title{margin:18px 2px 6px; color:var(--muted); font-weight:700; font-size:13px; letter-spacing:.35px}

  .card{
    background:linear-gradient(180deg, var(--card), #141821);
    border:2px solid var(--ring); border-radius:16px; padding:14px;
    box-shadow: 0 12px 24px var(--shadow); margin:12px 0;
  }
  .card h3{margin:0 0 4px; font-size:18px}

  .tag{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
    background:#0f1320; border:1px solid #1a2030; color:#cfd6e6; font-size:12px; font-weight:700;
  }
  .pill{ padding:6px 10px; border-radius:999px; border:1px dashed #2b3344; color:var(--muted); font-size:12px; font-weight:700 }
  .input, .number{
    width:100%; box-sizing:border-box; padding:12px 12px; color:var(--ink);
    background:#0e121b; border:1px solid var(--ring); border-radius:12px; outline:none;
  }
  .number{appearance:textfield}
  .number::-webkit-outer-spin-button,.number::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

  /* Square action buttons */
  .boxbtn{
    appearance:none; -webkit-appearance:none; cursor:pointer;
    border:2px solid transparent; color:#fff;
    padding:16px; border-radius:14px; font-weight:800; font-size:22px;
    display:inline-grid; place-items:center; min-width:72px; min-height:64px;
    box-shadow: 0 6px 18px var(--shadow); user-select:none; transition:.15s transform ease;
  }
  .boxbtn:active{ transform: translateY(1px) }
  .box-good{ background:linear-gradient(180deg, var(--good), var(--good-d)) }
  .box-bad{ background:linear-gradient(180deg, var(--bad), var(--bad-d)) }

  .btn{
    appearance:none; -webkit-appearance:none; cursor:pointer;
    border:1px solid var(--ring); background:transparent; color:var(--ink);
    padding:10px 14px; border-radius:12px; font-weight:700; transition:.15s transform ease;
  }
  .btn:active{ transform: translateY(1px) }
  .btn.small{ padding:6px 8px; border-radius:10px; font-size:12px }
  .btn.icon{ width:40px; height:40px; display:inline-grid; place-items:center; padding:0; font-size:18px }

  /* Goal bar */
  .goalTrack{height:10px;border:1px solid var(--ring);border-radius:10px;overflow:hidden}
  .goalFill{height:100%;width:0%; background:linear-gradient(90deg,#1bd67b,#7ee787)}

  /* Per-card accent via inline border color */
  .emoji{ font-size:20px; filter: drop-shadow(0 2px 6px rgba(255,255,255,.08)) }

  /* Confetti canvas */
  #fx{ position:fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none; z-index:999 }

  /* Streak mini-chart */
  .streak{ display:flex; gap:4px; flex-wrap:wrap; margin-top:8px }
  .dot{
    width:14px; height:14px; border-radius:4px; border:1px solid #2a3142; background:#0f1320;
  }
  .dot.plus{ background:#1b8f63 }   /* green for completed day */
  .dot.minus{ background:#7f1820 }  /* red for miss-only day */
  .dot.today{ outline:2px solid #e9ecf1; outline-offset:1px } /* highlight today */
  .legend{ color:var(--muted); font-size:11px }

  .empty{ color:var(--muted); text-align:center; padding:18px 8px; border:1px dashed #2a3142; border-radius:14px }
  .spacer{height: env(safe-area-inset-bottom)}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="app">
  <div class="topbar">
    <div class="row split">
      <div>
        <div class="sub">Total Cash Available</div>
        <div class="balance" id="cashTotal">$0.00</div>
      </div>
      <div class="row">
        <button class="btn" id="spendBtn">üõçÔ∏è Spend</button>
        <button class="btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="row" style="margin-top:6px; gap:12px">
      <div class="grow">
        <div class="row split">
          <div class="sub">Next Goal: <span id="goalName">‚Äî</span> (<span id="goalNeed">$0</span> left)</div>
          <div class="sub">Today: <span id="todayText">‚Äî</span> ¬∑ Step ¬±<span id="stepDisplay">$5</span></div>
        </div>
        <div class="goalTrack"><div id="goalBar" class="goalFill"></div></div>
      </div>
    </div>
  </div>

  <div class="section-title">Focus Today</div>
  <div id="focusList"></div>

  <div class="section-title">All Habits</div>
  <div id="habitList"></div>

  <div class="card">
    <h3>Add Habit</h3>
    <div class="row" style="gap:8px; margin-bottom:8px">
      <input id="newHabitName" class="input" placeholder="Habit name (e.g., Workout, Mindfulness)" />
      <input id="newHabitEmoji" class="input" placeholder="Emoji (e.g., üí™ or üßò)" style="max-width:110px" />
      <input id="newHabitColor" type="color" class="input" value="#7ee787" style="max-width:110px; padding:6px 8px; height:44px" />
      <input id="newHabitStart" type="number" class="number" inputmode="decimal" min="0" step="1" placeholder="Start $" style="max-width:130px" />
    </div>
    <div class="row">
      <button class="btn" id="addHabitBtn">Add Habit</button>
    </div>
    <div class="sub" style="margin-top:8px">
      Tap ‚úÖ to earn and lower incentive; tap ‚úñÔ∏è to raise incentive. Log multiple moments per day.
    </div>
  </div>

  <div class="section-title">History (today)</div>
  <div id="todayHistory" class="card"></div>

  <div class="spacer"></div>
</div>

<!-- Spend Modal -->
<dialog id="spendModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3>Spend Cash</h3>
    <div class="row"><input id="spendAmt" class="number" type="number" inputmode="decimal" min="0" step="1" placeholder="Amount $" /></div>
    <div class="row"><input id="spendNote" class="input" placeholder="What did you buy? (optional)" /></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn" value="submit">Spend</button>
    </div>
  </form>
</dialog>

<!-- Edit Habit Modal -->
<dialog id="editModal">
  <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
    <h3>Edit Habit</h3>
    <div class="row" style="gap:8px">
      <input id="editName" class="input" placeholder="Name" />
      <input id="editEmoji" class="input" placeholder="Emoji" style="max-width:110px" />
      <input id="editColor" type="color" class="input" value="#7ee787" style="max-width:110px; padding:6px 8px; height:44px" />
      <input id="editStart" type="number" class="number" min="0" step="1" placeholder="Current reward $" style="max-width:160px" />
    </div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn" value="submit">Save</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const fmt = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' });

  function todayKey(d=new Date()){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function niceDate(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }
  function cid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function round2(n){ return Math.round((Number(n)||0)*100)/100; }
  function buzz(ms=30){ try{ navigator.vibrate?.(ms); }catch{} }

  // WebAudio blip
  let audioCtx=null;
  function playKaching(){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o1 = audioCtx.createOscillator(), o2=audioCtx.createOscillator(), g=audioCtx.createGain();
      o1.type='square'; o2.type='triangle';
      o1.frequency.setValueAtTime(880, audioCtx.currentTime);
      o2.frequency.setValueAtTime(1320, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.35, audioCtx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.20);
      o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
      o1.start(); o2.start();
      o1.stop(audioCtx.currentTime+0.22); o2.stop(audioCtx.currentTime+0.22);
    }catch{}
  }

  // Confetti
  const fxCanvas = (()=>{ const c=document.createElement('canvas'); c.id='fx'; document.body.prepend(c); return c; })();
  const fxCtx = fxCanvas.getContext('2d');
  function sizeFx(){ fxCanvas.width=innerWidth*devicePixelRatio; fxCanvas.height=innerHeight*devicePixelRatio; }
  addEventListener('resize', sizeFx); sizeFx();
  function fireConfetti(hue=120){
    const particles=[];
    const N=90;
    for(let i=0;i<N;i++){
      particles.push({
        x: (Math.random()*innerWidth)*devicePixelRatio,
        y: (innerHeight*0.25 + Math.random()*innerHeight*0.1)*devicePixelRatio,
        vx: (Math.random()-0.5)*3*devicePixelRatio,
        vy: (Math.random()*-6 - 6)*devicePixelRatio,
        g: 0.22*devicePixelRatio,
        r: Math.random()*3+2,
        a: 1.0,
        hue: hue + (Math.random()*40-20)
      });
    }
    const start = performance.now();
    function tick(t){
      fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
      for(const p of particles){
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.a *= 0.985;
        fxCtx.beginPath(); fxCtx.fillStyle = `hsla(${p.hue},90%,70%,${p.a})`;
        fxCtx.arc(p.x,p.y,p.r,0,Math.PI*2); fxCtx.fill();
      }
      if(t-start < 1000){ requestAnimationFrame(tick); }
      else fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    }
    requestAnimationFrame(tick);
  }

  // ---------- State ----------
  const STORAGE_KEY='cashHabitRewards.v4';
  /**
   * version, cashTotal, step
   * habits: {
   *  id, name, emoji, color, incentive, step, streak,
   *  history: { [date]: { events: Array<{ts:number,type:'plus'|'minus',amount:number}> } },
   *  focusToday?: string
   * }
   * transactions: [{tsISO, evTs?, type:'earn'|'spend', habitId?, habitName?, amount, date}]
   * goal: {name, price, allocated}
   */
  let state = load();

  function load(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      try{
        const s=JSON.parse(saved);
        s.habits = (s.habits||[]).map(h=>({ emoji:'', color:'#7ee787', step:(s.step||5), streak:h.streak||0, history:{}, ...h }));
        if(!('goal' in s)) s.goal = { name:"Treat yo' self", price:150, allocated:0 };
        return s;
      }catch(e){}
    }
    // fresh
    return {
      version:4,
      cashTotal:0,
      step:5,
      habits:[
        { id:cid(), name:'Workout', emoji:'üí™', color:'#7ee787', incentive:20, step:5, streak:0, history:{}, focusToday:'' },
        { id:cid(), name:'Mindfulness', emoji:'üßò', color:'#8b9cf6', incentive:20, step:5, streak:0, history:{}, focusToday:'' },
        { id:cid(), name:'Sleep 7+ h', emoji:'üò¥', color:'#f7b955', incentive:20, step:5, streak:0, history:{}, focusToday:'' },
      ],
      transactions:[],
      goal: { name:"Treat yo' self", price:150, allocated:0 }
    };
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // ---------- Money & effects ----------
  function earn(habit, amount, evTs){
    state.cashTotal = round2(state.cashTotal + amount);
    if(state.goal){
      state.goal.allocated = Math.min(state.goal.price, round2((state.goal.allocated||0) + amount));
    }
    state.transactions.push({ tsISO:new Date().toISOString(), evTs, type:'earn', habitId:habit.id, habitName:habit.name, amount, date:todayKey() });
  }

  // ---------- Log actions ----------
  function logPlus(habit){
    const k=todayKey();
    if(!habit.history[k]) habit.history[k]={events:[]};

    // pay current incentive, then reduce incentive by step
    const payout = Math.max(0, habit.incentive);
    const evTs = Date.now();
    if(payout>0){ earn(habit, payout, evTs); }

    habit.incentive = Math.max(0, round2(habit.incentive - habit.step));
    habit.history[k].events.push({ ts:evTs, type:'plus', amount:payout });

    buzz(30); playKaching(); fireConfetti(hexToHue(habit.color));
    save(); render();
  }

  function logMinus(habit){
    const k=todayKey();
    if(!habit.history[k]) habit.history[k]={events:[]};

    habit.incentive = round2(habit.incentive + habit.step);
    habit.history[k].events.push({ ts:Date.now(), type:'minus', amount:habit.step });

    buzz(15);
    save(); render();
  }

  // Undo last tap (search latest event across ALL days for this habit)
  function undoLast(habit){
    let latestDate=null, latestIdx=-1, latestEv=null;
    for(const [date, rec] of Object.entries(habit.history)){
      const idx = (rec.events||[]).length-1;
      if(idx>=0){
        const last = rec.events[idx];
        if(!latestEv || last.ts > latestEv.ts){
          latestEv = last; latestIdx = idx; latestDate = date;
        }
      }
    }
    if(!latestEv){ alert('Nothing to undo for this habit.'); return; }

    if(latestEv.type==='plus'){
      // reverse cash & goal, restore incentive by step
      const tIndex = state.transactions.findIndex(t => t.type==='earn' && t.habitId===habit.id && t.evTs===latestEv.ts);
      if(tIndex>=0){
        const amt = state.transactions[tIndex].amount;
        state.cashTotal = round2(state.cashTotal - amt);
        if(state.goal){ state.goal.allocated = Math.max(0, round2((state.goal.allocated||0) - Math.min(amt, state.goal.allocated||0))); }
        state.transactions.splice(tIndex,1);
      }else{
        // fallback: reduce by event amount (best effort)
        state.cashTotal = round2(state.cashTotal - (latestEv.amount||0));
        if(state.goal){ state.goal.allocated = Math.max(0, round2((state.goal.allocated||0) - Math.min(latestEv.amount||0, state.goal.allocated||0))); }
      }
      habit.incentive = round2(habit.incentive + habit.step);
    } else if(latestEv.type==='minus'){
      // reverse incentive increase
      habit.incentive = Math.max(0, round2(habit.incentive - habit.step));
    }

    habit.history[latestDate].events.splice(latestIdx,1);
    if(habit.history[latestDate].events.length===0){ delete habit.history[latestDate]; }

    buzz(20);
    save(); render();
  }

  // ---------- Utilities ----------
  function hexToHue(hex){
    try{
      const c = hex.replace('#','');
      const r=parseInt(c.slice(0,2),16)/255, g=parseInt(c.slice(2,4),16)/255, b=parseInt(c.slice(4,6),16)/255;
      const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn; let h=0;
      if(d===0) h=0; else if(mx===r) h=((g-b)/d)%6; else if(mx===g) h=(b-r)/d+2; else h=(r-g)/d+4;
      h=Math.round(60*h); if(h<0) h+=360; return h;
    }catch{ return 120; }
  }

  function spend(amount, note){
    const amt = Number(amount)||0;
    if(amt<=0) return;
    if(amt>state.cashTotal){ alert(`You only have ${fmt.format(state.cashTotal)} available.`); return; }
    state.cashTotal = round2(state.cashTotal - amt);
    if(state.goal){ state.goal.allocated = Math.max(0, round2(state.goal.allocated - Math.min(amt, state.goal.allocated||0))); }
    state.transactions.push({ tsISO:new Date().toISOString(), type:'spend', amount:amt, date:todayKey(), note: String(note||'') });
    save(); render();
  }

  function addHabit(name, start, emoji, color){
    const nm = String(name||'').trim();
    if(!nm){ alert('Please enter a habit name.'); return; }
    let st = Number(start); if(!isFinite(st) || st<0) st = 20;
    const col = /^#?[0-9a-f]{6}$/i.test(String(color||'')) ? (String(color).startsWith('#')?color:'#'+color) : '#7ee787';
    state.habits.push({ id:cid(), name:nm, emoji:String(emoji||'').trim().slice(0,2), color:col, incentive:round2(st), step:state.step, streak:0, history:{}, focusToday:'' });
    save(); render();
    $('#newHabitName').value=''; $('#newHabitStart').value=''; $('#newHabitEmoji').value=''; // keep last used color
  }

  function deleteHabit(id){
    if(!confirm('Delete this habit? Past transactions stay in history.')) return;
    state.habits = state.habits.filter(h=>h.id!==id);
    save(); render();
  }

  function toggleFocus(habit){
    const k=todayKey();
    if(habit.focusToday===k){ habit.focusToday=''; }
    else{
      const focused = state.habits.filter(h=>h.focusToday===k);
      if(focused.length>=3){ alert('Limit is 3 Focus Today habits.'); return; }
      habit.focusToday=k;
    }
    save(); render();
  }

  // ---------- Streak calculation ----------
  function recomputeStreak(habit){
    // Count consecutive days up to today with any plus
    let count=0;
    for(let i=0;i<365;i++){
      const d=new Date(); d.setDate(d.getDate()-i); const key=todayKey(d);
      const ev=habit.history[key]?.events||[];
      const hasPlus = ev.some(e=>e.type==='plus' && e.amount>0);
      if(hasPlus) count++; else break;
    }
    habit.streak = count;
  }

  // ---------- UI ----------
  function render(){
    $('#cashTotal').textContent = fmt.format(state.cashTotal);
    $('#todayText').textContent = niceDate(new Date());
    $('#stepDisplay').textContent = `$${state.step}`;
    $('#goalName').textContent = state.goal?.name || '‚Äî';
    const need = Math.max(0, (state.goal?.price||0) - (state.goal?.allocated||0));
    $('#goalNeed').textContent = fmt.format(need);
    const pct = Math.min(100, ((state.goal?.allocated||0)/(state.goal?.price||1))*100);
    $('#goalBar').style.width = pct + '%';

    const k=todayKey();
    // Recompute streaks
    state.habits.forEach(recomputeStreak);

    const focused = state.habits.filter(h=>h.focusToday===k).sort((a,b)=>b.incentive-a.incentive);
    const others = state.habits.filter(h=>h.focusToday!==k).sort((a,b)=>b.incentive-a.incentive);

    const focusList = $('#focusList');
    focusList.innerHTML = focused.length ? '' : `<div class="empty">Tap üé® to set emoji/color. Tap ‚≠ê to pick up to 3 Focus Today.</div>`;
    focused.forEach(h=> focusList.appendChild(habitCard(h)));

    const list = $('#habitList');
    list.innerHTML = '';
    others.forEach(h=> list.appendChild(habitCard(h)));

    // today history
    const todays = state.transactions.filter(t=>t.date===k).slice(-18);
    const todayDiv = $('#todayHistory');
    todayDiv.innerHTML = todays.length? todays.map(t=>{
      if(t.type==='earn'){
        return `<div class="row split" style="margin:6px 0">
          <div>‚úÖ ${escapeHTML(t.habitName||'Habit')}</div>
          <div style="font-weight:700">${fmt.format(t.amount)}</div>
        </div>`;
      } else {
        return `<div class="row split" style="margin:6px 0">
          <div>üõçÔ∏è ${escapeHTML(t.note||'Spent')}</div>
          <div style="font-weight:700">‚àí${fmt.format(t.amount)}</div>
        </div>`;
      }
    }).join('') : `<div class="sub">No entries yet today.</div>`;
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function habitCard(habit){
    const k=todayKey();
    const ev = habit.history[k]?.events || [];
    const plusCount = ev.filter(e=>e.type==='plus').length;
    const minusCount = ev.filter(e=>e.type==='minus').length;

    const card = document.createElement('div');
    card.className = 'card';
    card.style.borderColor = habit.color||'#7ee787';   /* custom border color */

    // Build 14-day mini streak chart (oldest‚Üínewest)
    const dots = [];
    for(let i=13;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i); const key=todayKey(d);
      const dayEv = habit.history[key]?.events || [];
      const hasPlus = dayEv.some(e=>e.type==='plus' && e.amount>0);
      const hasMinusOnly = dayEv.length>0 && !hasPlus;
      dots.push(`<span class="dot ${hasPlus?'plus':hasMinusOnly?'minus':''} ${i===0?'today':''}" title="${key}"></span>`);
    }

    card.innerHTML = `
      <div class="row split" style="margin-bottom:8px">
        <div class="row" style="gap:10px">
          <button class="btn icon" title="Focus Today" data-action="focus">‚≠ê</button>
          <div>
            <h3><span class="emoji">${escapeHTML(habit.emoji||'')}</span> ${escapeHTML(habit.name)}</h3>
            <div class="row" style="gap:8px">
              <span class="tag" title="Next reward if you tap ‚úÖ">${fmt.format(habit.incentive)}</span>
              <span class="tag" title="Step">¬±$${habit.step}</span>
              <span class="tag" title="Streak">üî• ${habit.streak||0}</span>
              <button class="btn small" data-action="edit">üé® Edit</button>
              <button class="btn small" data-action="delete">üóëÔ∏è</button>
              <button class="btn small" data-action="undo">‚Ü©Ô∏è Undo last tap</button>
            </div>
            <div class="streak" aria-label="streak chart">
              ${dots.join('')}
              <div class="legend">Last 14 days ¬∑ green=done ¬∑ red=miss-only ¬∑ ‚óΩ=no log ¬∑ outlined=today</div>
            </div>
          </div>
        </div>
        <div class="tag">Today: +${plusCount} / ‚àí${minusCount}</div>
      </div>

      <div class="row center" style="gap:14px; flex-wrap:wrap; margin-top:6px">
        <button class="boxbtn box-good" data-action="plus" title="Complete">‚úÖ</button>
        <button class="boxbtn box-bad" data-action="minus" title="Didn‚Äôt">‚úñÔ∏è</button>
      </div>
    `;

    card.querySelector('[data-action="plus"]').addEventListener('click', ()=>logPlus(habit));
    card.querySelector('[data-action="minus"]').addEventListener('click', ()=>logMinus(habit));
    card.querySelector('[data-action="undo"]').addEventListener('click', ()=>undoLast(habit));
    card.querySelector('[data-action="delete"]').addEventListener('click', ()=>deleteHabit(habit.id));
    card.querySelector('[data-action="focus"]').addEventListener('click', ()=>toggleFocus(habit));
    card.querySelector('[data-action="edit"]').addEventListener('click', ()=>openEdit(habit));

    return card;
  }

  // ---------- Edit Habit ----------
  let editHabitRef=null;
  const editModal = $('#editModal');
  function openEdit(h){
    editHabitRef = h;
    $('#editName').value = h.name||'';
    $('#editEmoji').value = h.emoji||'';
    $('#editColor').value = h.color||'#7ee787';
    $('#editStart').value = String(h.incentive||0);
    editModal.showModal();
  }
  editModal.addEventListener('close', ()=>{
    if(editModal.returnValue==='submit' && editHabitRef){
      editHabitRef.name = String($('#editName').value||editHabitRef.name);
      editHabitRef.emoji = String($('#editEmoji').value||'').slice(0,2);
      editHabitRef.color = $('#editColor').value || editHabitRef.color;
      const val = Number($('#editStart').value);
      if(isFinite(val) && val>=0) editHabitRef.incentive = round2(val);
      save(); render();
    }
    editHabitRef=null;
  });

  // ---------- Wire-up global ----------
  $('#addHabitBtn').addEventListener('click', ()=>{
    addHabit($('#newHabitName').value, $('#newHabitStart').value, $('#newHabitEmoji').value, $('#newHabitColor').value);
  });
  ['#newHabitName','#newHabitStart','#newHabitEmoji'].forEach(sel=>{
    $(sel).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addHabitBtn').click(); }});
  });

  const spendModal = $('#spendModal');
  $('#spendBtn').addEventListener('click', ()=>spendModal.showModal());
  spendModal.addEventListener('close', ()=>{
    if(spendModal.returnValue==='submit'){
      spend($('#spendAmt').value, $('#spendNote').value);
      $('#spendAmt').value=''; $('#spendNote').value='';
    }
  });

  const settingsModal = document.createElement('dialog');
  settingsModal.innerHTML = `
    <form method="dialog" class="modal card" style="min-width:min(92vw,520px)">
      <h3>Settings</h3>
      <div class="row" style="gap:10px">
        <label class="pill">Global step (¬±):</label>
        <input id="stepInput" class="number" type="number" inputmode="decimal" min="1" step="1" placeholder="$ step" style="max-width:130px" />
      </div>
      <div class="section-title">Goal</div>
      <div class="row" style="gap:8px">
        <input id="goalTitle" class="input" placeholder="Goal name" />
        <input id="goalPrice" class="number" type="number" inputmode="decimal" min="1" step="1" placeholder="Price $" style="max-width:140px" />
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" value="cancel">Close</button>
        <button class="btn" value="submit">Save</button>
      </div>
    </form>`;
  document.body.appendChild(settingsModal);

  $('#settingsBtn').addEventListener('click', ()=>{
    settingsModal.querySelector('#stepInput').value = state.step;
    settingsModal.querySelector('#goalTitle').value = state.goal?.name || '';
    settingsModal.querySelector('#goalPrice').value = state.goal?.price || '';
    settingsModal.showModal();
  });
  settingsModal.addEventListener('close', ()=>{
    if(settingsModal.returnValue==='submit'){
      const n = Math.max(1, Math.floor(Number(settingsModal.querySelector('#stepInput').value)||state.step||5));
      state.step = n;
      const gName = String(settingsModal.querySelector('#goalTitle').value||'').trim();
      const gPrice = Math.max(1, Math.floor(Number(settingsModal.querySelector('#goalPrice').value)|| (state.goal?.price || 150)));
      if(!state.goal) state.goal = { name:gName||"Treat yo' self", price:gPrice, allocated:0 };
      else { state.goal.name = gName||state.goal.name; state.goal.price = gPrice; state.goal.allocated = Math.min(state.goal.price, state.goal.allocated||0); }
      save(); render();
    }
  });

  function tickHeader(){
    $('#todayText').textContent = niceDate(new Date());
    requestAnimationFrame(tickHeader);
  }
  tickHeader();
  render();

})();
</script>
</body>
</html>